<!DOCTYPE html>
<html>
<head>
    <title>AIR Roller</title>
    <link rel="stylesheet" type="text/css" href="/webclient/js/w2ui-1.5.rc1.min.css" />
    <link rel="stylesheet" type="text/css" href="/webclient/html/fa/css/all.css">
    <link rel="stylesheet" type="text/css" href="/webclient/html/rentroll.css">
    <link rel="stylesheet" type="text/css" href="/webclient/html/raflow/raflow.css">
    <link rel="icon" type="image/png" href="/webclient/html/images/roller-32.png">
</head>
<body>

<!--  color Icon images:  icon-page, w2ui-icon-check, ... see below in toptoolbar -->
<!--

mainlayout    - w2ui layout toptoolbar, toplayout, footer
toplayout     - w2ui layout for sidebar, main, and right (Detail)
reportslayout - w2ui layout for reports, main for reports, and top for toolbar
toptoolbar    - w2ui toolbar
sidebarL1     - w2ui sidebar

-->
<div id="layout" style="position: absolute; top: 0px; left: 0px; bottom: 0px; right: 0px;"></div>
<div id="blank_screen"></div>


<!-- SCRIPTS -->
<script src="/webclient/js/jquery.min.js"></script>
<script src="/webclient/js/w2ui-1.5.rc1.js"></script>
<script src="/webclient/js/bundle.js"></script>
<script>
/*global
    $, console, w2ui, defineDateFmts,
    dateControlString, dateMonthFwd, dateControlString, buildPageElementsWrapper,
    openInNewTab, logoff, launchSession, userProfileToUI,
*/


"use strict";

// unallocated receipts utility literal object

var _unAllocRcpts = {
    layoutPanels: {
        top: function(unallocFund, person/*, tcid*/) {
            return "<html><head><link rel=\"stylesheet\" href=\"/webclient/html/rentroll.css\"></head><body><div style=\"display: table; width: 100%; height: 40%;\"><div style=\"display: table-cell; vertical-align: middle;text-align: left;width: 100%;\"><p style=\"margin: 5px auto;font-size: 1.5rem;font-weight: bold;\" name=\"unallocForm\">"+person+"<br>Remaining unallocated funds:<span id=\"total_fund_amount\" data-fund=\""+unallocFund+"\"style=\"padding: 10px; color: #00AA00; font-size:1.5rem;font-weight: bold; margin: 10px auto; width: 30%;\">"+unallocFund+"</span>&nbsp;&nbsp;&nbsp;&nbsp;<button class=\"w2ui-btn w2ui-btn-green\" style=\"font-size: 1.1rem;\" id=\"auto_allocate_btn\">Auto-Allocate</button></p></div></div></body></html>";
        },
        bottom: function() {
            return "<div style=\"display: table; width: 100%; height: 100%;\"><div style=\"display: table-cell; vertical-align: middle;text-align: center;width: 100%;\"><button class=\"w2ui-btn\" id=\"alloc_fund_save_btn\">Save</button></div></div>";
        }
    }
};

// The rentroll app object, used to manage app-level data.
var app = {
    client: "roller",    // this is the roller web client
    D1: "2016-02-01",
    D2: "2016-03-01",
    Directory: "https://directory.airoller.com/",  // default value
    TZOffset: 0,         // will be set during initialization
    AssessmentRules: {},
    ReceiptRules: {},
    DepMethods: {},
    Depositories: {},    // gets loaded as needed
    ExpenseRules: {},
    StringList: {},
    CloseInfo: {},          // info for each business about last close
    CloseInfoTime: 0.0,     // number of seconds past unix epoch since last call to get CloseInfo
    CloseInfoInProg: false, // true if we are currently waiting on a response from the server
    CloseInfoReqStart: 0.0, // number of seconds past unix epoch since we initiated a query
    uid: 0,              // this is username's UID (user id)
    username: "",        // this is the logged in user's username
    name: "",            // first (or preferred) name of logged in user
    imageurl: "",        // pointer to image of logged in user
    PayorStmtExt: false, // false = internal, true = external
    WidestFormWidth: 900,
    sidebarWidth: 230,
    TmpTCID: 0,          // holds TCID of Payor from Apply Payments grid - Save function on unpaid assessments grid uses it
    TcidRAPayorPicker: {BID: 0},
    TcidRUserPicker: {BID: 0, Title: '', RAID: 0, RARentablesNames: [], RAR: []},
    RentalAgrPicker: {BID: 0, RAID: 0, TCID: 0, FirstName: '', LastName: '', CompanyName: '', IsCompany: false, RAR: [], RARentablesNames: []},
    ridRentablePicker: {BID: 0, Title: '', RAID: 0},
    asmsRevMode: [
        {id: 0, text: "this instance only"},
        {id: 1, text: "this and future instances"},
        {id: 2, text: "all instances"}
    ],
    ARTypes: {
        0: "Assessment",
        1: "Receipt",
        2: "Expense",
        3: "Sub-Assessment"
    },
    Assessments: [{id: 0, text: "Set Assessment Rule"},],
    Receipts: [{id: 1, text: "Set Payment Rule"},],
    AsmtModeCallerForm: null,
    language: "{{.Language}}",
    template: "{{.Template}}",
    pstyle: 'border: 1px solid #dfdfdf; padding: 0px;',
    pstyleNB: 'border: 0px solid #dfdfdf; padding: 0px;',
    pstyle4: 'border: 1px solid #bbbbbb; padding: 0px;',
    pstyle2: 'border: 1px solid #cfcfcf; padding: 0px;',
    //prefmt: 'font-family: "Monaco", "Menlo", "Source Code Pro", monospace; white-space: pre; font-size: 9pt; background-color: white;',
    prefmt: 'border:4px; solid #bbbbbb; background-color: white;',
    bgyellow: 'background-color: yellow;',
    stdfmt: 'font-family: "Open Sans","Roboto",sans-serif; font-size: 8pt; border: 1px solid #dfdfdf; border-spacing:0px; padding: 3px; color: #777777;',
    refreshInhibit: false,
    receiptsToolbarOnClickAdded: false,
    arList: [{id: 0, text:"Assessment"}, {id:1, text:"Receipt"}],
    rt_list: {},
    gl_accounts: {}, // this holds the list of GLAccount per business
    parent_accounts: {}, // possible parent accounts
    post_accounts: {}, // possible post accounts
    rof: {"csv": 4, "pdf": 3}, // report export/output format
    pdfPageWidth: 8.5, // defaults to USLetter Portrait width
    pdfPageHeight: 11, // defaults to USLetter Portrait height
    pageSizes: {
        "USLetter": { "w": 8.5, "h": 11 },
        "Legal": { "w": 8.5, "h": 14 },
        "Ledger": { "w": 11, "h": 17 },
    },
    active_grid: "", // which one is active now
    new_form_rec: false,
    active_form: "", // which form is active now
    form_is_dirty: false,
    active_form_original: {},
    last: {
        report: "",
        BUD: "",
        BID: -1,
    },
    tabKeyPressed : false, // flag to maintain default tab key behaviour
    shiftTabKeyPressed : false, // flag to maintain default tab+shift key behaviour
    dateFormatRegex : /^(0?[1-9]|1[0-2])\/(0?[1-9]|1\d|2\d|3[01])\/(19|20)\d{2}$/,
    w2ui: {
        listItems: {} // stores all list items{id, text} here
    },
    raflow: {
        loading:                    false,
        name:                       "RA",
        version:                    "",
        Flow:                       {}, // per Flow SECTION
        FlowFilledData:             {}, // per Flow SECTION
        validationCheck:            {}, // per Flow SECTION
        validationErrors:           {}, // per Flow SECTION
        arList:                     {},
        last:                       {},
        parentRentableW2UIItems:    [], // {id: RID, text: RentableName}
        peopleW2UIItems:            [], // {id: TMPTCID, text: fullname}
    },
    transactantFields:  [],
    transactantTabs:    [],
};

// delete confirmation dialog box options
var delete_confirm_options = {
    msg          : '<p>Are you sure you want to delete this record?</p>',
    title        : '',
    width        : 340,     // width of the dialog
    height       : 160,     // height of the dialog
    btn_yes      : {
        text     : 'Yes',   // text for yes button (or yes_text)
        class    : 'w2ui-btn w2ui-btn-red',      // class for yes button (or yes_class)
        style    : '',      // style for yes button (or yes_style)
        callBack : null     // callBack for yes button (or yes_callBack)
    },
    btn_no       : {
        text     : 'No',    // text for no button (or no_text)
        class    : 'w2ui-btn',      // class for no button (or no_class)
        style    : '',      // style for no button (or no_style)
        callBack : null     // callBack for no button (or no_callBack)
    },
    callBack     : null     // common callBack
};

// reverse confirmation dialog box options
var reverse_confirm_options = {
    msg          : '<p>Are you sure you want to reverse this entry?</p>',
    title        : '',
    width        : 340,     // width of the dialog
    height       : 160,     // height of the dialog
    btn_yes      : {
        text     : 'Yes',   // text for yes button (or yes_text)
        class    : 'w2ui-btn w2ui-btn-red',      // class for yes button (or yes_class)
        style    : '',      // style for yes button (or yes_style)
        callBack : null     // callBack for yes button (or yes_callBack)
    },
    btn_no       : {
        text     : 'No',    // text for no button (or no_text)
        class    : 'w2ui-btn',      // class for no button (or no_class)
        style    : '',      // style for no button (or no_style)
        callBack : null     // callBack for no button (or no_callBack)
    },
    callBack     : null     // common callBack
};

// The reason to load these elements in this way rather than storing them as part of a
// 'config' variable then passing them into the widget generators is that we need to
// download the lists first. Making the elements part of a config.* variable would evaluate
// the dropdown lists prior to downloading their values. By doing it this way, we download
// the lists first so that their values will be set by the server before we build the UI.
function buildPageElements() {
    //------------------------------------------------------------------------
    //          mainlayout
    //------------------------------------------------------------------------
    var now = new Date();
    var copyright = '&copy; 2015-' + now.getFullYear() + ' Accord Interests';
    $('#layout').w2layout({
        name: 'mainlayout',
        padding: 2,
        panels: [
            { type: 'top', size: 50, style: app.pstyle, content: 'top' },
            { type: 'left', size: app.sidebarWidth, hidden: true, style: app.pstyle, content: 'left' },
            { type: 'main', style: app.pstyle, content: 'main' },
            { type: 'preview', size: '50%', resizable: true, hidden: true, style: app.pstyle, content: 'preview' },
            { type: 'right', size: 200, resizable: true, style: app.pstyle, hidden: true, content: 'Details' },
            { type: 'bottom', size: 20, resizable: false, style: app.stdfmt, content: copyright }
        ]
    });

    //------------------------------------------------------------------------
    //          toptoolbar
    //------------------------------------------------------------------------
    w2ui.mainlayout.content('top', $().w2toolbar({
        name: 'toptoolbar',
        items: [
             { type: 'html',  id: 'logo',
                html: '<div style="padding: 4px 0px;"><table><tr valign="center">'+
                      '<td><img src="/webclient/html/images/air-48.png"></td>'+
                      '<td><img src="/webclient/html/images/roller-32.png"></td></tr></table></div>'
            },
            { type: 'break', id: 'break1' },
            { type: 'menu',    id: 'moduleMenu', caption: 'Select Module',    icon: 'fas fa-sitemap', items: [
                { text: 'Directory',          icon: 'fas fa-user' },
                { text: 'Roller',             icon: 'far fa-building' },
                { text: 'Mojo',               icon: 'far fa-envelope' },
                { text: 'Forms & Procedures', icon: 'fas fa-book' },
            ]},
            { type: 'html',  id: 'BUD',
                html: //'<div style="background-color: #eee; padding: 10px 5px; border-bottom: 1px solid silver">'+
                    '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<i class="far fa-building"></i> &nbsp;' + app.sBusinessUnit +
                    ': <span id="bizdropdown"><select name="BusinessSelect" onchange="ChangeBusiness();">'+
                    '{{range .BL}}<option value="{{.BID}}" name="{{.Designation}}">{{.Designation}}</option>{{end}}'+
                    '</select></span>&nbsp;&nbsp;&nbsp;' //+ '</div>'
            },
            { type: 'break',  id: 'break2' },
            { type: 'button', id: 'msgButton',  caption: 'News Flash', icon: 'fas fa-spinner fa-pulse fa-3x fa-fw'},
            { type: 'menu',   id: 'menuButton', caption: 'Developer',  icon: 'fas fa-user-circle', items: [
                { text: 'Webdocs',       icon: 'fas fa-book' },
                { text: 'Template-Dflt', icon: 'fas fa-language' },
                { text: 'Template-Apts', icon: 'fas fa-language' },
                { text: 'Messages',      icon: 'far fa-folder' },
            ]},
            { id: 'bt3', type: 'spacer' },
            { type: 'menu',   id: 'userMenu',
                caption: '<div id="user_menu_container">'+
                      '<span id="username"></span>'+
                      '<img src="" />'+
                      '</div>',
                items: [
                    { id: 'Profile'  , text: 'Profile' , icon: 'fas fa-user' },
                    { id: 'Settings' , text: 'Settings', icon: 'fas fa-cog' },
                    { id: 'Signout'  , text: 'Sign Out', icon: 'fas fa-sign-out-alt' },
                ],
            },
            { id: 'help', text: 'Help', type: 'button', icon: 'fas fa-question-circle' },
        ],
        onRender: function(event) {
            event.onComplete = function() {
                // when this render complete then store default selected business in app.last
                app.last.BUD = $("select[name=BusinessSelect]").find(":selected").attr("name");
                app.last.BID = parseInt($("select[name=BusinessSelect]").val());

                // check EDI mode for this business and set app.D2 accordingly
                if (EDIEnabledForBUD(app.last.BUD)) {
                    var d2 = dateFromString(app.D2);
                    d2.setDate(d2.getDate() - 1);
                    app.D2 = dateControlString(d2);
                }
            };
        },
        onRefresh: function(event) {
            event.onComplete = function() {
                userProfileToUI();
            };
        },
        onClick: function (event) {
            console.log('target = ' + event.target);
            switch(event.target) {
                case "moduleMenu:Directory":      window.location.href = 'https://directory.airoller.com/'; break;
                case "menuButton:Template-Dflt":  window.location.href = '/home/en-us/default';             break;
                case "menuButton:Template-Apts":  window.location.href = '/home/en-us/apts';                break;
                case "moduleMenu:RentRoll":       window.location.href = '/';                               break;
                case "moduleMenu:Mojo":           window.location.href = 'https://mojo.airoller.com:8275/'; break;
                case "menuButton:Webdocs":        openInNewTab('/doc/docs.html'); break;
                case "msgButton":
                case "menuButton:Messages":
                        w2ui.toplayout.toggle('top',true);
                        w2ui.toplayout.set('top',{ content: w2ui.newsLayout});
                        w2ui.newsLayout.load('main', '/webclient/html/news.html', 'flip-down', function () {console.log('content loaded');});
                        w2ui.toptoolbar.set('msgButton', {icon: 'far fa-newspaper'});
                        break;
                case "userMenu:Profile": break;
                case "userMenu:Settings": break;
                case "userMenu:Signout": logoff(); break;
                case "userMenu:Help":
                case "help":
                        // w2ui.toplayout.load('main', '/webclient/html/help.html');
                        w2ui.toplayout.content('main',w2ui.helpLayout);
                        w2ui.toplayout.hide('right',true);
                        break;
            }
        },
    }));
    buildPageElementsWrapper(0);
}  // buildPageElements

// $(document).ajaxSuccess(function(event, request, settings) {
//     if (settings.url !== loginTmplURL) {
//         var data;
//         try{
//             data = JSON.parse(request.responseText);
//         } catch(e) {
//             // nothing to do
//         }
//         if (data && 'message' in data) {
//             if (data.message.indexOf("session required") > -1) {
//                 //------------------------------------------------------------
//                 // The user needs to log in before we let them do anything...
//                 // IF Session Required...
//                 //------------------------------------------------------------
//                 $().w2popup('open', loginPopupOptions);
//                 setTimeout(function() {
//                     var f = w2ui.passwordform;
//                     $(f.box).find("#LoginMessage").find(".errors").empty();
//                     var message = "Your session hass expired. Please login again.";
//                     $(f.box).find("#LoginMessage").find(".errors").append("<p>" + message + "</p>");
//                     $(f.box).find("#LoginMessage").removeClass("hidden");
//                 }, 500);
//             }
//         }
//     }
// });

function finishInitialization() {
    defineDateFmts();
    buildPageElements();
    var d1 = new Date();
    d1.setDate(1);
    app.D1 = dateControlString(d1);
    var d2 = dateMonthFwd(d1);
    // set the default one at the moment, if date mode is enabled then
    // "BusinessSelect" render event handler will take care in top toolbar
    app.D2 = dateControlString(d2);
    app.TZOffset = new Date().getTimezoneOffset();
}

$(function () {
    $.get('/v1/uilists/' + app.language + '/' + app.template)
    .done(function(data, textStatus, jqXHR) {
        if (jqXHR.status == 200) {
            for( var key in data ) {   // fit all lists, values, maps in app variable
                app[key] = data[key];
            }
            prepareW2UIStuff(app);
        } else {
            console.log( '**** YIPES! ****  status on /v1/uilists/ = ' + textStatus);
        }
        finishInitialization();
        launchSession();
    })
    .fail( function() {
        console.log('Error getting /v1/uilists');
        console.log('*** NO INTERFACE ***');
    });
});

</script>

</body>
</html>
